# This Travis file is way more complex than we'd like. It needs to be quite
# similar to the praekelt/casepro Travis file because that's where this pod
# is installed. CasePro isn't served as a Python package which makes this
# difficult.

sudo: false

language: python
python:
  - '3.6'

services:
  - redis-server

addons:
  postgresql: "9.6"

before_install:
  # Clone the latest casepro repo, install the dependencies and setup
  # the database
  - git clone https://github.com/praekelt/casepro.git /tmp/casepro
  - pip install -r /tmp/casepro/pip-freeze.txt
  - psql -U postgres -c "CREATE USER casepro WITH PASSWORD 'nyaruka';"
  - psql -U postgres -c "ALTER ROLE casepro WITH SUPERUSER;"
  - psql -U casepro postgres -c "CREATE DATABASE casepro;"
  - psql -U casepro postgres -c "SELECT version();"
  # Append to the CasePro settings file to install this pod as an app
  - cat $TRAVIS_BUILD_DIR/.travis-casepro-additional-settings.py >> /tmp/casepro/casepro/settings.py.dev
  - ln -s /tmp/casepro/casepro/settings.py.dev /tmp/casepro/casepro/settings.py

install:
  - pip install -e $TRAVIS_BUILD_DIR/
  - pip install -r $TRAVIS_BUILD_DIR/requirements-dev.txt

script:
  - python /tmp/casepro/manage.py test -k $TRAVIS_BUILD_DIR/
  - flake8 $TRAVIS_BUILD_DIR/
